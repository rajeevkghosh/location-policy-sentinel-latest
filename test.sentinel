#This policy uses the Sentinel tfplan/v2 import to require that
# all GCE compute instances have all mandatory labels

# Note that the comparison is case-sensitive but also that GCE labels are only
# allowed to contain lowercase letters, numbers, hypens, and underscores.

# Import tfplan-functions.sentinel
# with alias "plan"
import "tfplan-functions" as plan
import "strings"
import "types"

prefix = "us-"
bq_multi_region = "US"

# Resource Types Region Map
resourceTypesRegionMap = {
	"google_pubsub_topic": {
		"key":   "message_storage_policy.0.allowed_persistence_regions",
		"array": null,
		"multi_region" : false,
	},
	"google_secret_manager_secret": {
		"key":   "location",
		"array": "replication.0.user_managed.0.replicas",
		"multi_region" : false,
	},
	"google_dataproc_cluster": {
		"key":   "cluster_config.0.encryption_config.0.kms_key_name",
		"array": null,
		"multi_region" : false,
	},
	"google_bigquery_dataset" : {
		"key":   "default_encryption_configuration.0.kms_key_name",
		"array": null,
		"multi_region" : false,
	},
}



allResources = {}
for resourceTypesRegionMap as rt, _ {
	resources = plan.find_resources(rt)
	for resources as address, rc {
		allResources[address] = rc
	}
}

print (allResources)

	

# Main rule
main = rule { GCP_PUBSUB_REGION and GCP_BIGQUERY_REGION }
